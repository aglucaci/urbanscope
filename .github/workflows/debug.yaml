name: UrbanScope Debug Run

on:
  workflow_dispatch:
    inputs:
      days:
        description: "How many days back to run (1 = today only)"
        required: true
        default: "1"
      max_per_day:
        description: "Max SRA records per day"
        required: true
        default: "200"
      query:
        description: "Optional override query (leave blank to use script default)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      # Recommended by NCBI for higher rate limits + attribution
      NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      NCBI_EMAIL: ${{ secrets.NCBI_EMAIL }}
      NCBI_TOOL: urbanscope-radar
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies (if any)
        run: |
          python -m pip install --upgrade pip
          # If you later add non-stdlib deps:
          # pip install -r requirements.txt

      - name: Ensure directories exist
        run: |
          mkdir -p data/debug data/cache docs/db docs/debug

      - name: Run debug pipeline
        run: |
          set -euo pipefail
          echo "days=${{ inputs.days }}"
          echo "max_per_day=${{ inputs.max_per_day }}"
          if [ -n "${{ inputs.query }}" ]; then
            echo "Using custom query"
            python scripts/urbanscope_radar.py daily \
              --days "${{ inputs.days }}" \
              --max-per-day "${{ inputs.max_per_day }}" \
              --query "${{ inputs.query }}" \
              --debug
          else
            echo "Using default query"
            python scripts/urbanscope_radar.py daily \
              --days "${{ inputs.days }}" \
              --max-per-day "${{ inputs.max_per_day }}" \
              --debug
          fi

      - name: Print latest debug counters
        run: |
          echo "=== docs/debug/latest_report.json ==="
          if [ -f docs/debug/latest_report.json ]; then
            cat docs/debug/latest_report.json
          else
            echo "Missing docs/debug/latest_report.json"
          fi

          echo ""
          echo "=== Most recent per-day report (data/debug/report_*.json) ==="
          ls -1 data/debug/report_*.json 2>/dev/null | tail -n 1 | xargs -I{} sh -c 'echo "FILE: {}"; cat {};'

      - name: Upload debug artifacts (download from Actions UI)
        uses: actions/upload-artifact@v4
        with:
          name: urbanscope-debug-artifacts
          path: |
            data/debug/
            docs/debug/latest_report.json
            docs/latest.json
            docs/db/index.json

      - name: Commit & push debug outputs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/debug/ docs/debug/ docs/latest.json docs/db/

          git commit -m "UrbanScope debug run (days=${{ inputs.days }})" \
            || echo "No changes to commit"

          git push
