name: UrbanScope Debug Run (Verbose)

on:
  workflow_dispatch:
    inputs:
      days:
        description: "How many days back to run (1 = today only)"
        required: true
        default: "1"
      max_per_day:
        description: "Max SRA records per day"
        required: true
        default: "200"
      query:
        description: "Optional override query (leave blank to use script default)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      NCBI_EMAIL: ${{ secrets.NCBI_EMAIL }}
      NCBI_TOOL: urbanscope-radar
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Environment + repo snapshot (pre)
        run: |
          set -euxo pipefail
          echo "PWD: $(pwd)"
          echo "DATE(UTC): $(date -u)"
          echo "Python:"
          python --version
          echo "Git:"
          git --version
          echo "Branch:"
          git rev-parse --abbrev-ref HEAD
          echo "Top-level:"
          ls -la
          echo "scripts/:"
          ls -la scripts || true
          echo "data/ (pre):"
          find data -maxdepth 3 -type f 2>/dev/null | sort | head -n 200 || true
          echo "docs/ (pre):"
          find docs -maxdepth 3 -type f 2>/dev/null | sort | head -n 200 || true

      - name: Run debug pipeline (tee log)
        run: |
          set -euxo pipefail
          mkdir -p logs data/debug data/cache docs/db docs/debug

          CMD="python scripts/urbanscope_radar.py daily --days '${{ inputs.days }}' --max-per-day '${{ inputs.max_per_day }}' --debug"
          if [ -n "${{ inputs.query }}" ]; then
            CMD="$CMD --query \"${{ inputs.query }}\""
          fi

          echo "Running: $CMD"
          # Run and keep full stdout/stderr
          bash -lc "$CMD" 2>&1 | tee logs/urbanscope_debug_run.log

      - name: Snapshot outputs (post)
        if: always()
        run: |
          set -euxo pipefail
          echo "Git status:"
          git status --short || true

          echo "data/debug/ (post):"
          ls -la data/debug || true
          echo "docs/debug/ (post):"
          ls -la docs/debug || true
          echo "docs/db/ (post):"
          ls -la docs/db || true

          echo "Most recent per-day report_*:"
          ls -1 data/debug/report_*.json 2>/dev/null | tail -n 5 || true

          echo "Most recent per-day decision_log_*:"
          ls -1 data/debug/decision_log_*.ndjson 2>/dev/null | tail -n 5 || true

      - name: Print latest debug report (human-readable)
        if: always()
        run: |
          set -euxo pipefail

          echo "=== docs/debug/latest_report.json ==="
          if [ -f docs/debug/latest_report.json ]; then
            cat docs/debug/latest_report.json
          else
            echo "MISSING: docs/debug/latest_report.json"
          fi

          echo ""
          echo "=== latest per-day report (data/debug/report_*.json) ==="
          LAST_REPORT="$(ls -1 data/debug/report_*.json 2>/dev/null | sort | tail -n 1 || true)"
          if [ -n "$LAST_REPORT" ]; then
            echo "FILE: $LAST_REPORT"
            cat "$LAST_REPORT"
          else
            echo "No per-day report files found in data/debug/"
          fi

          echo ""
          echo "=== quick counters extraction (best-effort) ==="
          # Simple grep-based extraction (no jq dependency)
          if [ -f docs/debug/latest_report.json ]; then
            grep -E '"sra_ids"|"summaries"|"elink_mapped"|"bpuid_resolved_to_accession"|"added"|"drop_' -n docs/debug/latest_report.json || true
          fi

      - name: Upload logs + debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: urbanscope-debug-logs-and-artifacts
          path: |
            logs/
            data/debug/
            docs/debug/latest_report.json
            docs/latest.json
            docs/db/index.json

      - name: Commit & push debug outputs
        if: always()
        run: |
          set -euxo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add logs/ data/debug/ docs/debug/ docs/latest.json docs/db/ || true

          git commit -m "UrbanScope debug run (days=${{ inputs.days }})" \
            || echo "No changes to commit"

          git push
