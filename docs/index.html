<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UrbanScope DB</title>
  <style>
    :root { --fg:#222; --muted:#666; --bg:#fff; --border:#e8e8e8; --chip:#f3f3f3; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:1200px;margin:32px auto;padding:0 16px;line-height:1.45;color:var(--fg);background:var(--bg)}
    h1{margin:0 0 6px 0}
    .muted{color:var(--muted)}
    a{text-decoration:none;color:#0b57d0}
    a:hover{text-decoration:underline}
    code{background:#f2f2f2;padding:2px 6px;border-radius:6px}
    .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:14px 0 18px 0}
    .chip{display:inline-block;background:var(--chip);border-radius:999px;padding:4px 10px;font-size:.85em;color:#444}
    .card{border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:0 4px 18px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:14px; margin:14px 0}
    @media(max-width: 980px){ .grid{grid-template-columns:1fr} }
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0}
    input,select,button{padding:10px 12px;border:1px solid #ddd;border-radius:12px;font:inherit}
    input{min-width:240px;flex:1}
    select{min-width:180px}
    button{cursor:pointer;background:#fff}
    button:hover{background:#fafafa}
    .kpi{display:flex;flex-wrap:wrap;gap:10px}
    .kpi .chip{padding:6px 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
    th{font-size:.9em;color:#444;text-align:left;position:sticky;top:0;background:#fff}
    .nowrap{white-space:nowrap}
    .small{font-size:.9em}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 10px;font-size:.82em;color:#444;margin-right:6px}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap}
    .pager{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px}
    .pager .left,.pager .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px}
    .modal{max-width:980px;width:100%;max-height:86vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modal header h3{margin:0;font-size:1.05em}
    .modal .content{padding:14px 16px}
    pre{white-space:pre-wrap;word-break:break-word;background:#f7f7f7;border:1px solid var(--border);border-radius:12px;padding:12px}
  </style>
</head>
<body>

  <h1>UrbanScope <span class="chip">simple database</span></h1>
  <p class="muted">
    Static, GitHub-native BioProject database for urban metagenomics & metatranscriptomics.
    Data lives in <code>docs/db/</code>.
  </p>

  <div class="grid">
    <div class="card">
      <div class="kpi" id="kpis">
        <span class="chip">Loading db/index.json…</span>
      </div>
      <div style="margin-top:10px" class="small muted" id="dbmeta"></div>
    </div>

    <div class="card">
      <div class="row-actions">
        <a href="db/records.csv">Download full CSV</a>
        <span class="muted">·</span>
        <a href="db/records.ndjson">Download full NDJSON</a>
        <span class="muted">·</span>
        <a href="archive/index.html">Archive</a>
        <span class="muted">·</span>
        <a href="latest.json">Latest run JSON</a>
      </div>
      <div class="small muted" style="margin-top:10px">
        Tip: pick a year, then filter/search. This loads only that year (fast + scalable).
      </div>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <select id="year"></select>

      <select id="studyType">
        <option value="">All study types</option>
        <option value="wastewater">wastewater</option>
        <option value="air">air</option>
        <option value="surface">surface</option>
        <option value="other">other</option>
      </select>

      <select id="country">
        <option value="">All countries</option>
      </select>

      <select id="city">
        <option value="">All cities</option>
      </select>

      <select id="sort">
        <option value="newest">Sort: newest</option>
        <option value="oldest">Sort: oldest</option>
        <option value="title">Sort: title</option>
        <option value="country">Sort: country</option>
        <option value="study_type">Sort: study type</option>
      </select>

      <input id="q" placeholder="Search (title, BioProject, PMID, SRA uid, links…)" />
    </div>

    <div class="small muted" id="status">Loading…</div>

    <table>
      <thead>
        <tr>
          <th class="nowrap">BioProject</th>
          <th>Title</th>
          <th class="nowrap">Location</th>
          <th class="nowrap">Type</th>
          <th class="nowrap">Links</th>
          <th class="nowrap">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="muted">Loading…</td></tr>
      </tbody>
    </table>

    <div class="pager">
      <div class="left">
        <button id="prev">Prev</button>
        <button id="next">Next</button>
        <span class="small muted" id="pageInfo"></span>
      </div>
      <div class="right">
        <label class="small muted">Rows/page</label>
        <select id="pageSize">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Details modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal">
      <header>
        <h3 id="modalTitle">Record</h3>
        <button id="close">Close</button>
      </header>
      <div class="content">
        <div class="small muted" id="modalMeta"></div>
        <pre id="json"></pre>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  const norm = (x) => (x ?? "").toString().toLowerCase();
  const uniq = (arr) => Array.from(new Set(arr)).filter(Boolean);
  const by = (keyFn) => (a,b) => keyFn(a).localeCompare(keyFn(b));
  const safe = (x) => (x === null || x === undefined) ? "" : x;

  // ---------- state ----------
  let DB = null;
  let YEAR = null;
  let RECORDS = [];
  let FILTERED = [];
  let page = 1;

  // ---------- DOM ----------
  const elYear = document.getElementById("year");
  const elType = document.getElementById("studyType");
  const elCountry = document.getElementById("country");
  const elCity = document.getElementById("city");
  const elSort = document.getElementById("sort");
  const elQ = document.getElementById("q");
  const elTbody = document.getElementById("tbody");
  const elStatus = document.getElementById("status");
  const elPageInfo = document.getElementById("pageInfo");
  const elPrev = document.getElementById("prev");
  const elNext = document.getElementById("next");
  const elPageSize = document.getElementById("pageSize");
  const elKpis = document.getElementById("kpis");
  const elDbmeta = document.getElementById("dbmeta");

  // modal
  const backdrop = document.getElementById("backdrop");
  const btnClose = document.getElementById("close");
  const modalTitle = document.getElementById("modalTitle");
  const modalMeta = document.getElementById("modalMeta");
  const preJson = document.getElementById("json");

  function openModal(record){
    const bp = record.bioproject || record.BioProject || "(unknown)";
    const title = record.representative?.title || record.title || "(no title)";
    modalTitle.textContent = `${bp}`;
    modalMeta.textContent = title;
    preJson.textContent = JSON.stringify(record, null, 2);
    backdrop.style.display = "flex";
  }
  function closeModal(){ backdrop.style.display = "none"; }
  btnClose.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

  // ---------- loading ----------
  async function loadIndex(){
    const res = await fetch("db/index.json", { cache: "no-store" });
    if(!res.ok) throw new Error(`Failed to load db/index.json (${res.status})`);
    DB = await res.json();

    const years = (DB.years || []).map(String);
    if(!years.length){
      elYear.innerHTML = `<option value="">No years</option>`;
      elKpis.innerHTML = `<span class="chip">No data yet</span>`;
      return;
    }

    elYear.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
    const latest = years[years.length-1];
    elYear.value = latest;

    const total = DB.total_records ?? DB.total_bioprojects ?? "(?)";
    elKpis.innerHTML = `
      <span class="chip">Total: <b>${total}</b></span>
      <span class="chip">Years: <b>${years.length}</b></span>
      <span class="chip">Updated: <b>${safe(DB.generated_at_utc)}</b></span>
    `;

    elDbmeta.textContent =
      `Downloads: records.csv, records.ndjson · This UI loads per-year slices from db/year/<YEAR>.json`;

    await loadYear(latest);
  }

  async function loadYear(year){
    YEAR = year;
    page = 1;
    elStatus.textContent = `Loading year ${year}…`;

    const res = await fetch(`db/year/${year}.json`, { cache: "no-store" });
    if(!res.ok){
      elStatus.textContent = `Failed to load db/year/${year}.json (${res.status}).`;
      RECORDS = [];
      FILTERED = [];
      render();
      return;
    }
    const data = await res.json();
    RECORDS = data.records || [];
    elStatus.textContent = `Loaded ${RECORDS.length} records for ${year}.`;

    // build dropdown values from loaded year
    const countries = uniq(RECORDS.map(r => r.derived?.country || r.country)).sort();
    const cities = uniq(RECORDS.map(r => r.derived?.city || r.city)).sort();

    elCountry.innerHTML = `<option value="">All countries</option>` + countries.map(c => `<option value="${c}">${c}</option>`).join("");
    elCity.innerHTML = `<option value="">All cities</option>` + cities.map(c => `<option value="${c}">${c}</option>`).join("");

    // reset filters
    elType.value = "";
    elCountry.value = "";
    elCity.value = "";
    elSort.value = "newest";
    elQ.value = "";

    apply();
  }

  // ---------- filtering/sorting/paging ----------
  function apply(){
    const q = norm(elQ.value);
    const st = norm(elType.value);
    const country = elCountry.value;
    const city = elCity.value;
    const sort = elSort.value;

    FILTERED = RECORDS.filter(r => {
      const title = r.representative?.title || r.title || "";
      const bp = r.bioproject || "";
      const pmid = r.pubmed?.pmid || r.pmid || "";
      const sra = r.representative?.sra_uid || r.sra_uid || "";
      const paper = r.pubmed?.paper || r.paper || "";
      const sralink = r.representative?.sra_link || r.sra_link || "";

      const rType = norm((r.derived?.study_type || r.study_type || "other"));
      const rCountry = (r.derived?.country || r.country || "");
      const rCity = (r.derived?.city || r.city || "");

      const blob = norm([title,bp,pmid,sra,paper,sralink].join(" "));

      const okQ = !q || blob.includes(q);
      const okT = !st || rType === st;
      const okC = !country || rCountry === country;
      const okCity = !city || rCity === city;
      return okQ && okT && okC && okCity;
    });

    // sort
    if(sort === "title"){
      FILTERED.sort(by(r => norm(r.representative?.title || r.title || "")));
    } else if(sort === "country"){
      FILTERED.sort(by(r => norm(r.derived?.country || r.country || "")));
    } else if(sort === "study_type"){
      FILTERED.sort(by(r => norm(r.derived?.study_type || r.study_type || "other")));
    } else if(sort === "oldest"){
      // day_utc ascending
      FILTERED.sort((a,b) => norm(a.provenance?.day_utc || a.day_utc || "").localeCompare(norm(b.provenance?.day_utc || b.day_utc || "")));
    } else {
      // newest first
      FILTERED.sort((a,b) => norm(b.provenance?.day_utc || b.day_utc || "").localeCompare(norm(a.provenance?.day_utc || a.day_utc || "")));
    }

    // reset to page 1 if current page now out of range
    const ps = parseInt(elPageSize.value, 10);
    const maxPage = Math.max(1, Math.ceil(FILTERED.length / ps));
    if(page > maxPage) page = 1;

    render();
  }

  function render(){
    const ps = parseInt(elPageSize.value, 10);
    const total = FILTERED.length;
    const maxPage = Math.max(1, Math.ceil(total / ps));
    const start = (page - 1) * ps;
    const end = Math.min(start + ps, total);
    const slice = FILTERED.slice(start, end);

    elPageInfo.textContent = `Showing ${start+1}-${end} of ${total} (page ${page}/${maxPage})`;

    elPrev.disabled = (page <= 1);
    elNext.disabled = (page >= maxPage);

    if(!total){
      elTbody.innerHTML = `<tr><td colspan="6" class="muted">No records match your filters for ${YEAR}.</td></tr>`;
      return;
    }

    elTbody.innerHTML = slice.map(r => {
      const bp = r.bioproject || "";
      const title = r.representative?.title || r.title || "";
      const st = r.derived?.study_type || r.study_type || "other";
      const city = r.derived?.city || r.city || "";
      const country = r.derived?.country || r.country || "";
      const pmid = r.pubmed?.pmid || r.pmid || "";
      const paper = r.pubmed?.paper || r.paper || "";
      const sra_uid = r.representative?.sra_uid || r.sra_uid || "";
      const sra_link = r.representative?.sra_link || r.sra_link || "";
      const day = r.provenance?.day_utc || r.day_utc || "";

      const loc = [city,country].filter(Boolean).join(", ") || "—";

      const links = `
        ${sra_link ? `<div><a href="${sra_link}" target="_blank" rel="noreferrer">SRA</a> <span class="pill">${safe(sra_uid)}</span></div>` : ""}
        ${paper ? `<div><a href="${paper}" target="_blank" rel="noreferrer">PubMed</a> <span class="pill">${safe(pmid)}</span></div>` : ""}
        ${day ? `<div class="muted small">Day: <code>${day}</code></div>` : ""}
      `;

      return `
        <tr>
          <td class="nowrap"><code>${bp}</code></td>
          <td>${title ? title : "<span class='muted'>—</span>"}</td>
          <td class="nowrap">${loc}</td>
          <td class="nowrap"><span class="chip">${st}</span></td>
          <td class="small">${links}</td>
          <td class="nowrap">
            <button data-bp="${bp}" class="details">Details</button>
          </td>
        </tr>
      `;
    }).join("");

    // attach detail handlers
    document.querySelectorAll("button.details").forEach(btn => {
      btn.addEventListener("click", () => {
        const bp = btn.getAttribute("data-bp");
        const rec = FILTERED.find(x => (x.bioproject || "") === bp);
        if(rec) openModal(rec);
      });
    });
  }

  // ---------- events ----------
  elYear.addEventListener("change", () => loadYear(elYear.value));
  [elType, elCountry, elCity, elSort].forEach(el => el.addEventListener("change", apply));
  elQ.addEventListener("input", apply);
  elPageSize.addEventListener("change", () => { page = 1; render(); });

  elPrev.addEventListener("click", () => { page = Math.max(1, page-1); render(); });
  elNext.addEventListener("click", () => { page = page+1; render(); });

  // ---------- init ----------
  loadIndex().catch(err => {
    elStatus.textContent = `Error: ${err.message}`;
    elTbody.innerHTML = `<tr><td colspan="6" class="muted">Failed to load database. Check that docs/db/index.json exists.</td></tr>`;
    console.error(err);
  });
</script>

</body>
</html>
