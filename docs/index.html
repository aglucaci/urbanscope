<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UrbanScope — BioProject Explorer</title>
  <style>
    :root{
      --bg:#0e1116;
      --panel:#151a21;
      --fg:#e6e9ef;
      --muted:#9aa4b2;
      --line:#2a3140;
      --chip:#1c2330;
      --accent:#4f7cff;
      --good:#3fbf8a;
      --warn:#e0b454;
      --bad:#e06666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0e1116;
      color:var(--fg);
    }
    a{color:inherit}
    .wrap{max-width:1400px;margin:18px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .muted{color:var(--muted)}
    .topline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line); background:#1a1f2b;
      padding:4px 10px;border-radius:999px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:980px){
      .grid{grid-template-columns:380px 1fr;}
    }
    .card{
      background:#151a21;
      border:1px solid var(--line); border-radius:16px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:.25px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--fg);
      padding:10px 10px;
      outline:none;
    }
    input::placeholder{color:rgba(159,176,218,.7)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border-radius:12px;
      border:1px solid var(--line);
      background:#243a7a;
      color:var(--fg);
      padding:10px 12px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary{background:#1a1f2b}
    button:disabled{opacity:.55;cursor:not-allowed}
    .tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:1180px;background:rgba(0,0,0,.1)}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(38,49,85,.7);vertical-align:top}
    th{
      position:sticky;top:0;
      background:#1b2130;
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.6px;
      z-index:2;
      cursor:pointer;
      user-select:none;
    }
    td{font-size:13px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      color:var(--fg);
      white-space:nowrap;
    }
    .chip.good{border-color:rgba(56,211,159,.35); background:rgba(56,211,159,.12)}
    .chip.warn{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.12)}
    .chip.bad{border-color:rgba(255,107,122,.35); background:rgba(255,107,122,.10)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .small{font-size:12px}
    .title{font-weight:750}
    .sub{color:var(--muted);font-size:12px;margin-top:3px;line-height:1.25}
    .pager{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .bar{height:8px;width:240px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid var(--line);overflow:hidden}
    .bar > div{height:100%;background:rgba(122,162,255,.55);width:0%}
    .err{color:var(--bad)}
    .ok{color:var(--good)}
    .footer{margin:18px 0;color:var(--muted);font-size:12px}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .rightTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .linkbtn{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);text-decoration:none;color:var(--fg);
      font-size:12px;font-weight:600;
    }

    /* Expandable runs */
    .expander{
      display:none;
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.10);
    }
    .expanderHead{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(38,49,85,.7);
      background:rgba(18,26,51,.60);
    }
    .expanderBody{padding:0}
    .miniWrap{overflow:auto}
    .miniTable{width:100%;border-collapse:collapse;min-width:1020px}
    .miniTable th{
      position:sticky;top:0;
      background:#1b2130;
      z-index:1;
      font-size:11px;
    }
    .miniTable th, .miniTable td{padding:8px 10px;border-bottom:1px solid rgba(38,49,85,.7)}
    .tagbtn{
      border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      font-size:12px;font-weight:700;
    }

    /* Stats lists */
    .statGrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){ .statGrid{grid-template-columns:1fr 1fr;} }
    .statList{display:flex;flex-direction:column;gap:6px}
    .statRow{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border:1px solid rgba(38,49,85,.7);border-radius:12px;
      background:#1a1f2b;
    }
    .statKey{min-width:160px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .statBar{flex:1;height:8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);overflow:hidden}
    .statBar > div{height:100%;width:0%;background:rgba(122,162,255,.55)}
    .statVal{min-width:72px;text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
  
    /* Checkbox */
    .checkrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .checkrow input[type="checkbox"]{width:auto;transform:scale(1.05);accent-color:var(--accent)}
    .checkrow label{margin:0;display:flex;gap:10px;align-items:center;cursor:pointer}
    
</style>
</head>
<body>
  <div class="wrap">
    
<header>
  <div style="min-width:280px;flex:1">
    <div style="display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap">
      <div style="display:flex;flex-direction:column;gap:4px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(79,124,255,.12)"></div>
          <h1 style="margin:0;font-size:20px;letter-spacing:.2px">UrbanScope BioProject Explorer</h1>
        </div>
        <div class="muted" style="font-size:13px;line-height:1.35;max-width:920px">
          A curated, queryable index of environmental sequencing runs grouped by <b>NCBI BioProject</b>.
          Designed for city-confined metagenomics discovery (built environment, wastewater, transit, air, surfaces).
        </div>
      </div>
    </div>

    <div class="topline" style="margin-top:10px">
      <span class="pill" id="pGenerated">Loading…</span>
      <span class="pill" id="pTotals">—</span>
      <span class="pill" id="pParts">—</span>
      <span class="pill"><span class="mono">Source</span>: <span class="mono">docs/db/</span></span>
    </div>

    <div class="card" style="margin-top:12px;padding:12px;border-radius:16px">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div style="min-width:260px;flex:1">
          <div style="font-weight:700;font-size:13px;letter-spacing:.2px;margin-bottom:6px">Database overview</div>
          <div class="hint" style="margin:0">
            This page loads a <b>manifest</b> and one or more <b>part files</b> containing SRR-level records.
            Records are aggregated into <b>one row per BioProject</b> and can be expanded to view underlying SRR/SRA runs.
          </div>
          <div class="hint" style="margin-top:8px">
            <span class="mono">Manifest</span>:
            <span class="mono">docs/db/srr_records_manifest.json</span> → file list, generation timestamp, and total record count.
            <br/>
            <span class="mono">Parts</span>:
            <span class="mono">docs/db/srr_records_partXXX.json</span> → arrays of SRR records (RunInfo + derived annotations).
          </div>
        </div>

        <div style="min-width:260px;flex:1">
          <div style="font-weight:700;font-size:13px;letter-spacing:.2px;margin-bottom:6px">What is in each record?</div>
          <div class="hint" style="margin:0">
            Core fields are sourced from <b>SRA RunInfo</b> and joined with optional enrichments:
            <ul style="margin:8px 0 0 18px;padding:0">
              <li><span class="mono">runinfo_row</span>: SRR, BioProject, BioSample, dates, platform, center</li>
              <li><span class="mono">bioproject</span>: accession/title (when available)</li>
              <li><span class="mono">geo</span>: <b>country</b> and <b>city</b> (from BioSample/location parsing)</li>
              <li><span class="mono">assay</span>: assay class (e.g., WGS, RNA-seq, 16S/ITS)</li>
            </ul>
          </div>
          <div class="hint" style="margin-top:8px">
            Use <b>Require Country/City</b> and <b>Exclude (unknown)</b> to keep only geographically resolved projects.
          </div>
        </div>

        <div class="rightTop" style="align-items:flex-start">
          <a class="linkbtn" href="./latest_srr.json" target="_blank" rel="noopener">latest_srr.json</a>
          <a class="linkbtn" href="./db/srr_records_manifest.json" target="_blank" rel="noopener">manifest</a>
        </div>
      </div>
    </div>
  </div>
</header>


    <div class="grid">
      <div class="card">
        <h2>Filters</h2>

        <div class="row">
          <div style="flex:1;min-width:240px">
            <label>Search (BioProject / title / SRR / center / country / city)</label>
            <input id="q" placeholder='e.g., "PRJNA", "subway", "NYC", "TSINGHUA"' />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Country</label>
            <select id="country"><option value="">(any)</option></select>
          </div>
          <div>
            <label>City</label>
            <select id="city"><option value="">(any)</option></select>
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Assay class</label>
            <select id="assay"><option value="">(any)</option></select>
          </div>
          <div>
            <label>Center</label>
            <input id="center" placeholder='e.g., "Weill Cornell", "TSINGHUA"' />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Min year</label>
            <input id="minYear" placeholder="e.g. 2024" inputmode="numeric" />
          </div>
          <div>
            <label>Max year</label>
            <input id="maxYear" placeholder="e.g. 2026" inputmode="numeric" />
          </div>
        </div>

        <div class="checkrow">
          <label for="requireGeo">
            <input type="checkbox" id="requireGeo" checked />
            <span class="small">Require Country <span class="muted">and</span> City (hide projects with missing geo)</span>
          </label>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Load mode</label>
            <select id="mode">
              <option value="stream">Stream parts (fast UI updates)</option>
              <option value="all">Load all parts (best for stats)</option>
            </select>
          </div>
        <div class="checkrow">
          <label for="excludeUnknown">
            <input type="checkbox" id="excludeUnknown" checked />
            <span class="small">Exclude <span class="mono">(unknown)</span> in Country/City (hide projects with unknown geo)</span>
          </label>
        </div>
          <div>
            <label>Projects per page</label>
            <select id="perPage">
              <option>25</option>
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
              <option>500</option>
            </select>
          </div>
        </div>

        <div class="btns">
          <button id="btnApply">Apply</button>
          <button class="secondary" id="btnReset">Reset</button>
          <button class="secondary" id="btnStop" disabled>Stop loading</button>
          <button class="secondary" id="btnExport">Export current page (JSON)</button>
        </div>

        <div style="margin-top:12px">
          <div class="status">
            <div class="bar"><div id="prog"></div></div>
            <div class="small muted" id="pLoad">—</div>
          </div>
          <div class="small muted" id="pMsg" style="margin-top:8px">—</div>
        </div>
      </div>

      <div class="card">
        <h2>BioProjects</h2>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill" id="pMatched">Matched: —</span>
            <span class="pill" id="pShown">Showing: —</span>
            <span class="pill">Sort: <span class="mono" id="sortKey">samples</span> <span id="sortDir">▼</span></span>
          </div>
          <div class="row small muted">
            Tip: click a column header to sort · click “Expand” to see SRRs
          </div>
        </div>

        <div class="tableWrap" style="margin-top:10px">
          <table id="tbl">
            <thead>
              <tr>
                <th data-k="bioproject">BioProject</th>
                <th data-k="bioproject_title">Title</th>
                <th data-k="samples">Runs</th>
                <th data-k="biosamples">BioSamples</th>
                <th data-k="countries">Countries</th>
                <th data-k="cities">Cities</th>
                <th data-k="assays">Assays</th>
                <th data-k="years">Years</th>
                <th data-k="expand">Details</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="9" class="muted">Loading manifest…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="pager">
          <div class="row">
            <button id="prev">Prev</button>
            <button id="next">Next</button>
            <span class="small muted" id="pageInfo">—</span>
          </div>
          <div class="small muted">
            Sorting is by BioProject-level aggregates (runs, unique BioSamples, etc.).
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Where do the samples come from?</h2>
          <div class="hint" style="margin-bottom:10px">
            Stats are computed on the <b>currently matched BioProjects</b> (after filters). If your geo fields are empty,
            you’ll see “(unknown)” buckets — that’s a sign your BioSample enrichment step needs to fill <span class="mono">geo.country</span>/<span class="mono">geo.city</span>.
          </div>

          <div class="statGrid">
            <div>
              <div class="row" style="justify-content:space-between;margin-bottom:6px">
                <div class="muted small">Countries (top 15)</div>
                <div class="muted small" id="countryTotal">—</div>
              </div>
              <div class="statList" id="countryStats"></div>
            </div>
            <div>
              <div class="row" style="justify-content:space-between;margin-bottom:6px">
                <div class="muted small">Cities (top 15)</div>
                <div class="muted small" id="cityTotal">—</div>
              </div>
              <div class="statList" id="cityStats"></div>
            </div>
          </div>
        </div>

        <div class="footer">
          Files expected under <span class="mono">docs/db/</span>:
          <span class="mono">srr_records_manifest.json</span>,
          <span class="mono">srr_records_part000.json</span>, …
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // --------- Config ----------
  const MANIFEST_URL = "./db/srr_records_manifest.json";
  const PART_BASE = "./db/"; // we normalize manifest paths that include docs/db\...

  // --------- State ----------
  let manifest = null;
  let allRuns = [];          // SRR-level records
  let allProjects = [];      // BioProject-level aggregates
  let matchedProjects = [];
  let page = 1;
  let perPage = 100;
  let sortKey = "samples";
  let sortAsc = false;
  let aborter = null;

  // --------- Elements ----------
  const el = (id) => document.getElementById(id);
  const tbody = el("tbody");
  const prog = el("prog");

  const pGenerated = el("pGenerated");
  const pTotals = el("pTotals");
  const pParts = el("pParts");
  const pLoad = el("pLoad");
  const pMsg = el("pMsg");

  const pShown = el("pShown");
  const pMatched = el("pMatched");
  const pageInfo = el("pageInfo");

  const q = el("q");
  const assay = el("assay");
  const country = el("country");
  const city = el("city");
  const center = el("center");
  const minYear = el("minYear");
  const maxYear = el("maxYear");
  const mode = el("mode");
  const perPageSel = el("perPage");
  const requireGeo = el("requireGeo");
  const excludeUnknown = el("excludeUnknown");

  const btnApply = el("btnApply");
  const btnReset = el("btnReset");
  const btnStop = el("btnStop");
  const btnExport = el("btnExport");

  const prev = el("prev");
  const next = el("next");

  const countryStats = el("countryStats");
  const cityStats = el("cityStats");
  const countryTotal = el("countryTotal");
  const cityTotal = el("cityTotal");

  // --------- Helpers ----------
  const norm = (s) => (s ?? "").toString().trim();
  const lower = (s) => norm(s).toLowerCase();
  const uniq = (arr) => Array.from(new Set(arr.filter(Boolean)));

  function isUnknownGeo(v) {
    const s = norm(v);
    return (!s) || (s.toLowerCase() === "(unknown)");
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function safeInt(x) {
    const n = parseInt((x ?? "").toString(), 10);
    return Number.isFinite(n) ? n : null;
  }

  function safeYearFromRec(rec) {
    // Prefer ReleaseDate -> year
    const rd = rec?.runinfo_row?.ReleaseDate || rec?.runinfo_row?.LoadDate || "";
    const m = rd.match(/^(\d{4})-/);
    if (m) return safeInt(m[1]);
    return null;
  }

  function normalizePartPath(p) {
    // Manifest can contain paths like "docs/db\\srr_records_part000.json"
    let s = (p ?? "").toString().replaceAll("\\", "/");
    // Strip leading docs/ if present
    if (s.startsWith("docs/")) s = s.slice(5);
    // If it's just a filename, prefix PART_BASE
    if (!s.includes("/")) s = PART_BASE + s;
    // Ensure it begins with ./db/ for GitHub Pages relative access
    if (s.startsWith("db/")) s = "./" + s;
    if (!s.startsWith("./")) s = "./" + s.replace(/^\/+/, "");
    return s;
  }

  function setProgress(done, total) {
    const pct = total ? Math.round((done / total) * 100) : 0;
    prog.style.width = `${pct}%`;
  }

  function setMsg(html, cls="muted") {
    pMsg.className = "small " + cls;
    pMsg.innerHTML = html;
  }

  function getBPAcc(rec) {
    return rec?.runinfo_row?.BioProject || rec?.bioproject?.accession || "";
  }
  function getBPTitle(rec) {
    return rec?.bioproject?.title || rec?.bioproject?.bioproject_title || rec?.bioproject?.name || "";
  }
  function getAssayClass(rec) {
    return rec?.assay?.assay_class || rec?.runinfo_row?.LibraryStrategy || "Unknown";
  }
  function getCountry(rec) {
    return rec?.geo?.country || "";
  }
  function getCity(rec) {
    return rec?.geo?.city || "";
  }
  function getCenter(rec) {
    return rec?.runinfo_row?.CenterName || "";
  }
  function getSRR(rec) {
    return rec?.srr || rec?.runinfo_row?.Run || "";
  }
  function getSRAStudy(rec) {
    return rec?.runinfo_row?.SRAStudy || "";
  }
  function getBioSample(rec) {
    return rec?.runinfo_row?.BioSample || rec?.geo?.biosample_accession || "";
  }
  function getSampleName(rec) {
    return rec?.runinfo_row?.SampleName || "";
  }
  function getSciName(rec) {
    return rec?.runinfo_row?.ScientificName || "";
  }
  function getPlatform(rec) {
    const p = rec?.runinfo_row?.Platform || "";
    const m = rec?.runinfo_row?.Model || "";
    return (p && m) ? `${p} / ${m}` : (p || m);
  }
  function getLayout(rec) {
    return rec?.runinfo_row?.LibraryLayout || "";
  }
  function getLibSource(rec) {
    return rec?.runinfo_row?.LibrarySource || "";
  }

  // --------- Aggregation ----------
  function buildProjectsFromRuns(runs) {
    const map = new Map();
    for (const rec of runs) {
      const bp = norm(getBPAcc(rec)) || "(no_bioproject)";
      if (!map.has(bp)) {
        map.set(bp, {
          bioproject: bp,
          title: norm(getBPTitle(rec)),
          bioproject_url: rec?.ncbi?.bioproject_url || (bp && bp !== "(no_bioproject)"
            ? `https://www.ncbi.nlm.nih.gov/bioproject/?term=${encodeURIComponent(bp)}`
            : ""),
          runs: [],
        });
      }
      const obj = map.get(bp);
      if (!obj.title) obj.title = norm(getBPTitle(rec));
      obj.runs.push(rec);
    }

    // Derive aggregates
    const projects = [];
    for (const [bp, obj] of map.entries()) {
      const yrs = obj.runs.map(safeYearFromRec).filter(y => y != null);
      const assays = uniq(obj.runs.map(getAssayClass));
      const countries = obj.runs.map(getCountry).map(norm).filter(Boolean);
      const cities = obj.runs.map(getCity).map(norm).filter(Boolean);
      const centers = obj.runs.map(getCenter).map(norm).filter(Boolean);

      const biosamples = uniq(obj.runs.map(getBioSample).map(norm).filter(Boolean));
      const minY = yrs.length ? Math.min(...yrs) : null;
      const maxY = yrs.length ? Math.max(...yrs) : null;

      projects.push({
        bioproject: bp,
        title: obj.title,
        bioproject_url: obj.bioproject_url,
        samples: obj.runs.length,
        biosamples: biosamples.length,
        assays,
        min_year: minY,
        max_year: maxY,
        countries_top: topCounts(countries, 3),
        cities_top: topCounts(cities, 3),
        centers_top: topCounts(centers, 2),
        runs: obj.runs,
      });
    }
    return projects;
  }

  function topCounts(values, k=3) {
    const counts = {};
    for (const v of values) {
      const key = v || "(unknown)";
      counts[key] = (counts[key] || 0) + 1;
    }
    const arr = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,k);
    return arr; // [ [name, count], ... ]
  }

  function countMap(values, unknownLabel="(unknown)") {
    const m = new Map();
    for (const v of values) {
      const key = norm(v) || unknownLabel;
      m.set(key, (m.get(key) || 0) + 1);
    }
    return Array.from(m.entries()).sort((a,b) => b[1]-a[1]);
  }

  // --------- Filtering ----------
  function projectMatches(p) {
    const qq = lower(q.value);
    const wantAssay = norm(assay.value);
    const wantCountry = norm(country.value);
    const wantCity = norm(city.value);
    const wantCenter = lower(center.value);
    const minY = safeInt(minYear.value);
    const maxY = safeInt(maxYear.value);

    // Geo completeness filter (enabled by default)
    // - requireGeo: require at least one run with BOTH country and city
    // - excludeUnknown: treat "(unknown)" as missing and hide projects with unknown geo
    const wantRequireGeo = (requireGeo && requireGeo.checked) ? true : false;
    const wantExcludeUnknown = (excludeUnknown && excludeUnknown.checked) ? true : false;

    if (wantRequireGeo || wantExcludeUnknown) {
      const hasCountry = p.runs.some(r => !isUnknownGeo(getCountry(r)));
      const hasCity = p.runs.some(r => !isUnknownGeo(getCity(r)));
      if (!(hasCountry && hasCity)) return false;
    }

    if (wantExcludeUnknown) {
      // If ANY run has unknown country OR unknown city, exclude the BioProject
      const anyUnknown = p.runs.some(r => isUnknownGeo(getCountry(r)) || isUnknownGeo(getCity(r)));
      if (anyUnknown) return false;
    }

    // Year filter uses project min/max (if missing, it passes unless min/max explicitly require overlap)
    if (minY != null) {
      if (p.max_year == null) return false;
      if (p.max_year < minY) return false;
    }
    if (maxY != null) {
      if (p.min_year == null) return false;
      if (p.min_year > maxY) return false;
    }

    if (wantAssay) {
      if (!p.assays.includes(wantAssay)) return false;
    }

    if (wantCountry) {
      const countries = p.runs.map(r => norm(getCountry(r)) || "(unknown)");
      if (!countries.includes(wantCountry)) return false;
    }
    if (wantCity) {
      const cities = p.runs.map(r => norm(getCity(r)) || "(unknown)");
      if (!cities.includes(wantCity)) return false;
    }

    if (wantCenter) {
      const centers = p.runs.map(r => lower(getCenter(r)));
      if (!centers.some(c => c.includes(wantCenter))) return false;
    }

    if (qq) {
      // Search across bp, title, SRRs, centers, geo
      const srrs = p.runs.slice(0, 200).map(r => norm(getSRR(r))).join(" "); // cap to avoid huge strings
      const centers = p.centers_top.map(x => x[0]).join(" ");
      const blob = `${p.bioproject} ${p.title} ${srrs} ${centers} ${p.countries_top.map(x=>x[0]).join(" ")} ${p.cities_top.map(x=>x[0]).join(" ")} ${p.assays.join(" ")}`.toLowerCase();
      if (!blob.includes(qq)) return false;
    }

    return true;
  }

  function applyFilters() {
    // Rebuild projects from runs (stream mode grows over time)
    allProjects = buildProjectsFromRuns(allRuns);

    // Refresh filter dropdowns (based on runs, not projects)
    populateFacets();

    matchedProjects = allProjects.filter(projectMatches);
    matchedProjects.sort(sortFn);

    page = 1;
    render();
    renderStats();
  }

  // --------- Sorting ----------
  function sortVal(p, k) {
    switch (k) {
      case "bioproject": return p.bioproject;
      case "bioproject_title": return p.title || "";
      case "samples": return p.samples;
      case "biosamples": return p.biosamples;
      case "countries": return (p.countries_top?.[0]?.[0] || "");
      case "cities": return (p.cities_top?.[0]?.[0] || "");
      case "assays": return p.assays.join(", ");
      case "years": return (p.min_year ?? -1);
      default: return p.samples;
    }
  }

  function sortFn(a,b) {
    const ak = sortVal(a, sortKey);
    const bk = sortVal(b, sortKey);
    if (ak === bk) return 0;
    if (ak == null) return sortAsc ? 1 : -1;
    if (bk == null) return sortAsc ? -1 : 1;
    return sortAsc ? (ak > bk ? 1 : -1) : (ak < bk ? 1 : -1);
  }

  function setSort(k) {
    if (k === "expand") return;
    if (sortKey === k) sortAsc = !sortAsc;
    else { sortKey = k; sortAsc = (k === "bioproject" || k === "bioproject_title" || k === "countries" || k === "cities" || k === "assays" || k === "years") ? true : false; }
    el("sortKey").textContent = k;
    el("sortDir").textContent = sortAsc ? "▲" : "▼";
    matchedProjects.sort(sortFn);
    render();
    renderStats();
  }

  // --------- Rendering ----------
  function render() {
    perPage = parseInt(perPageSel.value, 10) || 100;
    const total = matchedProjects.length;
    const pages = Math.max(1, Math.ceil(total / perPage));
    page = Math.min(page, pages);

    const start = (page - 1) * perPage;
    const end = Math.min(total, start + perPage);
    const slice = matchedProjects.slice(start, end);

    pMatched.textContent = `Matched: ${total.toLocaleString()} BioProjects`;
    pShown.textContent = `Showing: ${slice.length.toLocaleString()}`;
    pageInfo.textContent = `Page ${page} / ${pages}`;

    prev.disabled = page <= 1;
    next.disabled = page >= pages;

    if (!slice.length) {
      tbody.innerHTML = `<tr><td colspan="9" class="muted">No results (try loosening filters).</td></tr>`;
      return;
    }
    tbody.innerHTML = slice.map(projectToRow).join("");

    // Wire expanders
    for (const tr of tbody.querySelectorAll("tr[data-bp]")) {
      const bp = tr.getAttribute("data-bp");
      const btn = tr.querySelector("button[data-expand]");
      const box = tr.querySelector(".expander");
      if (btn && box) {
        btn.addEventListener("click", () => {
          const isOpen = box.style.display !== "none";
          box.style.display = isOpen ? "none" : "block";
          btn.textContent = isOpen ? "Expand" : "Collapse";
          btn.classList.toggle("secondary", isOpen);
          if (!isOpen) renderRunsInto(box, bp);
        });
      }
    }
  }

  function projectToRow(p) {
    const bp = escapeHtml(p.bioproject);
    const bpUrl = p.bioproject_url || (p.bioproject && p.bioproject !== "(no_bioproject)"
      ? `https://www.ncbi.nlm.nih.gov/bioproject/?term=${encodeURIComponent(p.bioproject)}`
      : "#");

    const countries = p.countries_top.length
      ? p.countries_top.map(([k,v]) => `<span class="chip">${escapeHtml(k)} <span class="muted">(${v})</span></span>`).join("")
      : `<span class="muted">—</span>`;

    const cities = p.cities_top.length
      ? p.cities_top.map(([k,v]) => `<span class="chip">${escapeHtml(k)} <span class="muted">(${v})</span></span>`).join("")
      : `<span class="muted">—</span>`;

    const assays = (p.assays?.length)
      ? p.assays.slice(0,4).map(a => `<span class="chip ${a === "Unknown" ? "warn" : "good"}">${escapeHtml(a)}</span>`).join("")
      : `<span class="muted">—</span>`;

    const years = (p.min_year != null || p.max_year != null)
      ? `<span class="mono">${p.min_year ?? "—"}–${p.max_year ?? "—"}</span>`
      : `<span class="muted">—</span>`;

    const centers = p.centers_top?.length
      ? `<div class="sub">Centers: ${p.centers_top.map(([k,v]) => `${escapeHtml(k)} (${v})`).join(", ")}</div>`
      : ``;

    return `
      <tr data-bp="${escapeHtml(p.bioproject)}">
        <td class="mono">
          ${p.bioproject && p.bioproject !== "(no_bioproject)"
            ? `<a href="${bpUrl}" target="_blank" rel="noopener">${bp}</a>`
            : `<span class="muted">${bp}</span>`
          }
        </td>
        <td>
          <div class="title">${p.title ? escapeHtml(p.title) : `<span class="muted">—</span>`}</div>
          ${centers}
        </td>
        <td class="mono">${p.samples.toLocaleString()}</td>
        <td class="mono">${p.biosamples.toLocaleString()}</td>
        <td><div class="chips">${countries}</div></td>
        <td><div class="chips">${cities}</div></td>
        <td><div class="chips">${assays}</div></td>
        <td>${years}</td>
        <td>
          <button class="tagbtn" data-expand="1">Expand</button>
          <div class="expander" style="display:none">
            <div class="expanderHead">
              <div class="small muted">
                <span class="mono">${bp}</span> · ${p.samples.toLocaleString()} runs · ${p.biosamples.toLocaleString()} biosamples
              </div>
              <div class="row">
                <a class="linkbtn" href="${bpUrl}" target="_blank" rel="noopener">Open BioProject</a>
              </div>
            </div>
            <div class="expanderBody">
              <div class="miniWrap">
                <table class="miniTable">
                  <thead>
                    <tr>
                      <th>SRR</th>
                      <th>SRA UID</th>
                      <th>BioSample</th>
                      <th>Assay</th>
                      <th>Country</th>
                      <th>City</th>
                      <th>Year</th>
                      <th>Center</th>
                      <th>Platform</th>
                      <th>Layout</th>
                      <th>Organism</th>
                    </tr>
                  </thead>
                  <tbody class="miniBody">
                    <tr><td colspan="11" class="muted">Loading runs…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  function renderRunsInto(expanderEl, bioprojectAcc) {
    // Find the project in current matched list (or allProjects)
    const p = allProjects.find(x => x.bioproject === bioprojectAcc) || matchedProjects.find(x => x.bioproject === bioprojectAcc);
    const body = expanderEl.querySelector(".miniBody");
    if (!p || !body) return;

    // Sort runs by ReleaseDate desc (approx: year desc then SRR)
    const runs = p.runs.slice().sort((a,b) => {
      const ay = safeYearFromRec(a) ?? -1;
      const by = safeYearFromRec(b) ?? -1;
      if (ay !== by) return by - ay;
      return (norm(getSRR(a)) < norm(getSRR(b))) ? -1 : 1;
    });

    body.innerHTML = runs.map(rec => {
      const srr = norm(getSRR(rec));
      const srrUrl = rec?.ncbi?.srr_url || (srr ? `https://www.ncbi.nlm.nih.gov/sra/?term=${encodeURIComponent(srr)}` : "#");
      const sraUid = norm(rec?.sra_uid);
      const sraUrl = rec?.ncbi?.sra_uid_url || (sraUid ? `https://www.ncbi.nlm.nih.gov/sra/?term=${encodeURIComponent(sraUid)}` : "#");

      const assay = norm(getAssayClass(rec)) || "Unknown";
      const ctry = norm(getCountry(rec)) || "(unknown)";
      const cty = norm(getCity(rec)) || "(unknown)";
      const yr = safeYearFromRec(rec);
      const cn = norm(getCenter(rec)) || "(unknown)";
      const bs = norm(getBioSample(rec)) || "(unknown)";
      const platform = norm(getPlatform(rec)) || "(unknown)";
      const layout = norm(getLayout(rec)) || "";
      const org = norm(getSciName(rec)) || "";

      return `
        <tr>
          <td class="mono"><a href="${srrUrl}" target="_blank" rel="noopener">${escapeHtml(srr)}</a></td>
          <td class="mono">${sraUid ? `<a href="${sraUrl}" target="_blank" rel="noopener">${escapeHtml(sraUid)}</a>` : `<span class="muted">—</span>`}</td>
          <td class="mono">${escapeHtml(bs)}</td>
          <td><span class="chip ${assay === "Unknown" ? "warn" : "good"}">${escapeHtml(assay)}</span></td>
          <td>${escapeHtml(ctry)}</td>
          <td>${escapeHtml(cty)}</td>
          <td class="mono">${yr ?? "—"}</td>
          <td>${escapeHtml(cn)}</td>
          <td>${escapeHtml(platform)}</td>
          <td class="mono">${escapeHtml(layout)}</td>
          <td>${escapeHtml(org)}</td>
        </tr>
      `;
    }).join("");
  }

  // --------- Stats ----------
  function renderStats() {
    // Stats are on SRR-level runs within matched projects
    const runs = matchedProjects.flatMap(p => p.runs);

    let ctries = runs.map(r => norm(getCountry(r)) || "(unknown)");
    let ctys = runs.map(r => norm(getCity(r)) || "(unknown)");
    // Exclude unknown buckets if requested
    if (excludeUnknown && excludeUnknown.checked) {
      ctries = ctries.filter(v => v.toLowerCase() !== "(unknown)");
      ctys = ctys.filter(v => v.toLowerCase() !== "(unknown)");
    }

    const ctryCounts = countMap(ctries, "(unknown)").slice(0, 15);
    const ctyCounts = countMap(ctys, "(unknown)").slice(0, 15);

    countryTotal.textContent = `${runs.length.toLocaleString()} runs`;
    cityTotal.textContent = `${runs.length.toLocaleString()} runs`;

    renderStatList(countryStats, ctryCounts);
    renderStatList(cityStats, ctyCounts);
  }

  function renderStatList(container, entries) {
    if (!entries.length) {
      container.innerHTML = `<div class="muted small">No data.</div>`;
      return;
    }
    const max = Math.max(...entries.map(e => e[1]));
    container.innerHTML = entries.map(([k,v]) => {
      const pct = max ? Math.round((v / max) * 100) : 0;
      return `
        <div class="statRow">
          <div class="statKey small">${escapeHtml(k)}</div>
          <div class="statBar"><div style="width:${pct}%"></div></div>
          <div class="statVal small">${v.toLocaleString()}</div>
        </div>
      `;
    }).join("");
  }

  // --------- Facets (dropdown options) ----------
  function populateFacets() {
    // Build from runs so stream mode stays accurate
    const assays = uniq(allRuns.map(getAssayClass).map(norm).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
    const countries = uniq(allRuns.map(getCountry).map(x => norm(x) || "(unknown)")).sort((a,b)=>a.localeCompare(b));
    const cities = uniq(allRuns.map(getCity).map(x => norm(x) || "(unknown)")).sort((a,b)=>a.localeCompare(b));

    fillSelect(assay, assays, "(any)");
    fillSelect(country, countries, "(any)");
    fillSelect(city, cities, "(any)");
  }

  function fillSelect(sel, values, anyLabel="(any)") {
    const cur = sel.value;
    const opts = [`<option value="">${anyLabel}</option>`]
      .concat(values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
    sel.innerHTML = opts.join("");
    if (values.includes(cur)) sel.value = cur;
    else sel.value = "";
  }

  // --------- Loading ----------
  async function loadManifest() {
    const r = await fetch(MANIFEST_URL, {cache:"no-store"});
    if (!r.ok) throw new Error(`Failed to fetch manifest: ${r.status} ${r.statusText}`);
    manifest = await r.json();
    return manifest;
  }

  async function loadParts({loadAll}) {
    if (!manifest?.parts?.length) return;

    // Cancel any previous loading
    if (aborter) aborter.abort();
    aborter = new AbortController();

    btnStop.disabled = false;
    setMsg(loadAll ? "Loading all part files…" : "Streaming part files (you can stop anytime)…", "muted");

    const totalParts = manifest.parts.length;
    let loadedParts = 0;
    let loadedRecords = 0;

    for (const part of manifest.parts) {
      if (aborter.signal.aborted) break;

      const url = normalizePartPath(part.path);
      pLoad.textContent = `Loaded ${loadedParts}/${totalParts} parts · ${loadedRecords.toLocaleString()} records`;
      setProgress(loadedParts, totalParts);

      let data = null;
      try {
        const r = await fetch(url, {signal: aborter.signal, cache:"no-store"});
        if (!r.ok) throw new Error(`Fetch failed: ${r.status} ${r.statusText}`);
        data = await r.json();
      } catch (e) {
        setMsg(`Error loading <span class="mono">${escapeHtml(url)}</span>: <span class="err">${escapeHtml(e.message)}</span>`, "err");
        break;
      }

      if (Array.isArray(data)) {
        allRuns.push(...data);
        loadedRecords += data.length;
        loadedParts += 1;
      } else {
        loadedParts += 1;
      }

      // Update live in stream mode
      if (!loadAll) {
        applyFilters();
      }
    }

    setProgress(totalParts, totalParts);
    pLoad.textContent = `Loaded ${loadedParts}/${totalParts} parts · ${loadedRecords.toLocaleString()} records`;
    btnStop.disabled = true;

    if (!aborter.signal.aborted) {
      setMsg(`<span class="ok">Ready.</span> Loaded ${loadedRecords.toLocaleString()} SRR records.`, "ok");
    } else {
      setMsg(`<span class="warn">Stopped.</span> Loaded ${loadedRecords.toLocaleString()} SRR records so far.`, "muted");
    }

    applyFilters();
  }

  function resetUI() {
    q.value = "";
    assay.value = "";
    country.value = "";
    city.value = "";
    center.value = "";
    minYear.value = "";
    maxYear.value = "";
    if (requireGeo) requireGeo.checked = true;
    if (excludeUnknown) excludeUnknown.checked = true;
    perPageSel.value = "100";
    mode.value = "stream";
    sortKey = "samples";
    sortAsc = false;
    el("sortKey").textContent = sortKey;
    el("sortDir").textContent = "▼";
    page = 1;
    applyFilters();
  }

  function exportCurrentPage() {
    perPage = parseInt(perPageSel.value, 10) || 100;
    const start = (page - 1) * perPage;
    const end = Math.min(matchedProjects.length, start + perPage);
    const slice = matchedProjects.slice(start, end).map(p => ({
      bioproject: p.bioproject,
      title: p.title,
      samples: p.samples,
      biosamples: p.biosamples,
      assays: p.assays,
      years: {min: p.min_year, max: p.max_year},
      countries_top: p.countries_top,
      cities_top: p.cities_top,
      centers_top: p.centers_top,
      runs: p.runs, // keep full records for now; you can strip later if size is an issue
    }));

    const blob = new Blob([JSON.stringify({
      exported_utc: new Date().toISOString(),
      page,
      per_page: perPage,
      sort: {key: sortKey, asc: sortAsc},
      filters: {
        q: q.value,
        assay: assay.value,
        country: country.value,
        city: city.value,
        center: center.value,
        min_year: minYear.value,
        max_year: maxYear.value
      },
      projects: slice
    }, null, 2)], {type:"application/json"});

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `urbanscope_bioproject_page_${page}.json`;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 2000);
  }

  // --------- Events ----------
  btnApply.addEventListener("click", applyFilters);
  btnReset.addEventListener("click", resetUI);
  btnStop.addEventListener("click", () => { if (aborter) aborter.abort(); btnStop.disabled = true; });
  btnExport.addEventListener("click", exportCurrentPage);

  prev.addEventListener("click", () => { page = Math.max(1, page - 1); render(); });
  next.addEventListener("click", () => { page = page + 1; render(); });

  // Sort on header click
  document.querySelectorAll("th[data-k]").forEach(th => {
    th.addEventListener("click", () => setSort(th.getAttribute("data-k")));
  });

  // Apply on Enter in search boxes
  [q, center, minYear, maxYear].forEach(inp => {
    inp.addEventListener("keydown", (e) => { if (e.key === "Enter") applyFilters(); });
  });

  if (requireGeo) requireGeo.addEventListener("change", applyFilters);
  if (excludeUnknown) excludeUnknown.addEventListener("change", applyFilters);

  // --------- Init ----------
  (async () => {
    try {
      const mf = await loadManifest();
      pGenerated.textContent = `Generated: ${mf.generated_utc || mf.generated || "—"}`;
      pTotals.textContent = `Total SRR records: ${(mf.total_records ?? mf.total_srr_records ?? "—").toLocaleString?.() ?? (mf.total_records ?? mf.total_srr_records ?? "—")}`;
      pParts.textContent = `Parts: ${(mf.parts?.length ?? 0).toLocaleString()}`;

      // Load data
      const loadAll = mode.value === "all";
      await loadParts({loadAll});

      // If user flips mode later, re-load on demand
      mode.addEventListener("change", async () => {
        // If switching from stream->all, do a full reload for best stats.
        const wantAll = mode.value === "all";
        allRuns = [];
        tbody.innerHTML = `<tr><td colspan="9" class="muted">Reloading…</td></tr>`;
        await loadParts({loadAll: wantAll});
      });

      setMsg(`<span class="ok">Ready.</span> BioProject aggregation is live.`, "ok");
    } catch (e) {
      setMsg(`<span class="err">${escapeHtml(e.message)}</span>`, "err");
      tbody.innerHTML = `<tr><td colspan="9" class="err">Failed to initialize: ${escapeHtml(e.message)}</td></tr>`;
    }
  })();
})();
</script>
</body>
</html>
